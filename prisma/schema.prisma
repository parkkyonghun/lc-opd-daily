generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String                 @id @default(cuid())
  email               String                 @unique
  name                String
  password            String
  role                String                 @default("user") // Legacy field, kept for backward compatibility
  branchId            String?
  isActive            Boolean                @default(true)
  lastLogin           DateTime?
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  failedLoginAttempts Int                    @default(0)
  lockedUntil         DateTime?
  username            String                 @unique
  activityLogs        ActivityLog[]
  branch              Branch?                @relation(fields: [branchId], references: [id])
  branchAssignments   UserBranchAssignment[]
  userRoles           UserRole[]
}

model UserBranchAssignment {
  id        String   @id @default(cuid())
  userId    String
  branchId  String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  branch    Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([userId, branchId])
  @@unique([userId], map: "UserBranchAssignment_userId_isDefault_key", where: isDefault = true)
  @@index([userId])
  @@index([branchId])
}

model Branch {
  id                String                 @id @default(cuid())
  code              String                 @unique
  name              String
  isActive          Boolean                @default(true)
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  parentId          String?
  parent            Branch?                @relation("BranchHierarchy", fields: [parentId], references: [id])
  children          Branch[]               @relation("BranchHierarchy")
  reports           Report[]
  users             User[]
  branchAssignments UserBranchAssignment[]
  userRoles         UserRole[]
}

model Report {
  id          String   @id @default(cuid())
  date        String   // Store as YYYY-MM-DD
  branch      Branch   @relation(fields: [branchId], references: [id])
  branchId    String
  writeOffs   Float
  ninetyPlus  Float
  reportType  String   @default("actual") // 'plan' or 'actual'
  status      String   @default("pending") // 'pending', 'approved', 'rejected'
  submittedBy String
  submittedAt String
  comments    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([date, branchId, reportType])
}

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  details   String?
  ipAddress String?
  userAgent String?
  timestamp DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Role {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  userRoles   UserRole[]
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  roleId    String
  branchId  String?
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  branch    Branch?  @relation(fields: [branchId], references: [id], onDelete: SetNull)

  @@unique([userId, roleId, branchId])
  @@unique([userId], map: "UserRole_userId_isDefault_key", where: isDefault = true)
  @@index([userId])
  @@index([roleId])
  @@index([branchId])
}
